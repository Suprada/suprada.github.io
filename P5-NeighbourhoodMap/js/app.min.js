var bouncingMarker=null,map,infoWnd;$(document).ready(function(){var e=new ViewModel;ko.applyBindings(e)});var gMap=function(e){var o={zoom:10,center:e};return element=$("#map")[0],map=new google.maps.Map(element,o)},Location=function(e,o,a,n,r,t){this.name=ko.observable(e),this.phone=ko.observable(o),this.website=ko.observable(a),this.address=ko.observable(n),this.coordinates=ko.observable(r),this.provider=ko.observable(t)},HoodSearch=function(e,o){var a=this;a.zipCode=ko.observable(e),a.searchStr=ko.observable(o),a.locations=ko.observableArray([])},ViewModel=function(){function o(e){console.log("Hi! I was clicked. My name is "+e.title),console.log(e.title),bouncingMarker&&bouncingMarker.setAnimation(null),bouncingMarker!=e?(e.setAnimation(google.maps.Animation.BOUNCE,e),setTimeout(function(){e.setAnimation(null)},1400),bouncingMarker=e):bouncingMarker=null}function a(e){for(var o=0;o<r().length;o++)r()[o].setMap(e)}var n=this,r=ko.observableArray([]),t=new google.maps.LatLng(37.253,-122.051),s=!1;infoWnd=new google.maps.InfoWindow,n.init=function(){map=gMap(t),google.maps.event.addDomListener(window,"resize",function(){var e=map.getCenter();google.maps.event.trigger(map,"resize"),map.setCenter(e)}),n.hoodSearch=new HoodSearch("95070","books"),n.hoodSearch.searchStr.subscribe(i,n,"beforeChange"),n.hoodSearch.zipCode.subscribe(i,n,"beforeChange"),l(n.hoodSearch)},("object"!=typeof google||"object"!=typeof google.maps)&&$("#search-summary").text("Could not load Google Maps API");var i=function(){s=!0},c=function(e){var o="https://maps.googleapis.com/maps/api/geocode/json?address="+n.hoodSearch.zipCode()+"&key=AIzaSyBzuACUkJySquLnpuEBXe51AUgfoF8x3FY";$.ajax(o).done(function(o){t=o.results[0].geometry.location,e.panTo(t)})},u=function(e){n.hoodSearch=e,m()};this.updateHoodSearch=function(){1==s?(c(map),infoWnd&&infoWnd.close(),bouncingMarker=null,n.hoodSearch.locations(null),g(),l(n.hoodSearch),s=!1):console.log("Ignoring submit - params not changed")};var l=function(e){var o={consumerKey:"NfTfKiQ-p4yTBPabsgUaaw",consumerSecret:"tKyDFmQuhQ08ZXXgXjym3VTrQSU",accessToken:"xl64BB_BCPqzf9RpuNu_XaWexw8k7kz1",accessTokenSecret:"bu3L4T7SBMJa0K_PDHUu93DyqcI",serviceProvider:{signatureMethod:"HMAC-SHA1"}},a=e.searchStr(),n=e.zipCode(),r=10,t={consumerSecret:o.consumerSecret,tokenSecret:o.accessTokenSecret};parameters=[],parameters.push(["term",a]),parameters.push(["limit",r]),parameters.push(["location",n]),parameters.push(["callback","cb"]),parameters.push(["oauth_consumer_key",o.consumerKey]),parameters.push(["oauth_consumer_secret",o.consumerSecret]),parameters.push(["oauth_token",o.accessToken]),parameters.push(["oauth_signature_method","HMAC-SHA1"]);var s={action:"http://api.yelp.com/v2/search",method:"GET",parameters:parameters};OAuth.setTimestampAndNonce(s),OAuth.SignatureMethod.sign(s,t);var i=OAuth.getParameterMap(s.parameters);i.oauth_signature=OAuth.percentEncode(i.oauth_signature);var c=setTimeout(function(){$(".pure-menu-heading").html("<h2>Sorry! Cannot load yelp data</h2>")},8e3);$.ajax({url:s.action,data:i,cache:!0,dataType:"jsonp",jsonpCallback:"cb",success:function(o){clearTimeout(c),p(o.businesses,e)}})},p=function(e,o){var a=[];e.forEach(function(e){var o=e.name,n=e.phone,r=e.url,t=e.location.display_address,s=e.location.coordinate,i="Yelp",c=new Location(o,n,r,t,s,i);a.push(c)}),o.locations(a),u(o)},m=function(){var a=n.hoodSearch.locations();for(var t in a){var s=a[t];if("Yelp"==a[t].provider())var i={url:"http://yelp-images.s3.amazonaws.com/assets/map-markers/annotation_48x64.png",scaledSize:new google.maps.Size(18,24)};nmarker=new google.maps.Marker({map:map,title:s.name(),animation:google.maps.Animation.DROP,icon:i,position:new google.maps.LatLng(s.coordinates().latitude,s.coordinates().longitude),website:s.website(),address:s.address(),phone:s.phone(),provider:s.provider()}),nmarker.addListener("click",function(){e=this,o(e),h(e)}),r.push(nmarker)}},h=function(e){var o='<a href="'+e.website+'">'+e.title+"</a><br>";this.phone&&(o+="Ph: "+e.phone.substr(0,3)+"-"+e.phone.substr(3,3)+"-"+e.phone.substr(6,4)+"<br>"),o+=e.address[0]+"<br>"+e.address[1],infoWnd.setContent(o),infoWnd.open(map,e)},d=function(){a(null)},g=function(){d()};n.currentFilter=ko.observable(),n.filter=function(){n.currentFilter(this.name())},n.filterLocation=ko.computed(function(){if(n.currentFilter()){console.log("do something"),a=r().length;for(var e=0,a=r().length;a>e;e++)if(r()[e].title==n.currentFilter()){console.log("Match Found");var t=r()[e];o(t),h(t)}}else;}),n.init()};